/**
 * Patches node-pty native build files to work on Windows without Spectre-mitigated
 * libraries and without relying on GetCommitHash.bat.
 * Run this after `npm install` and before `electron-forge start`.
 */
const fs = require('fs');
const path = require('path');

const nodeModules = path.join(__dirname, '..', 'node_modules', 'node-pty');

// 1. Create gen/GenVersion.h
const genDir = path.join(nodeModules, 'deps', 'winpty', 'src', 'gen');
fs.mkdirSync(genDir, { recursive: true });

const versionFile = path.join(nodeModules, 'deps', 'winpty', 'VERSION.txt');
const version = fs.existsSync(versionFile) ? fs.readFileSync(versionFile, 'utf-8').trim() : '0.0.0';

fs.writeFileSync(
  path.join(genDir, 'GenVersion.h'),
  `// AUTO-GENERATED by fix-node-pty.js\nconst char GenVersion_Version[] = "${version}";\nconst char GenVersion_Commit[] = "none";\n`
);

// 2. Patch winpty.gyp - remove cmd calls and Spectre mitigation
const winptyGyp = path.join(nodeModules, 'deps', 'winpty', 'src', 'winpty.gyp');
if (fs.existsSync(winptyGyp)) {
  let content = fs.readFileSync(winptyGyp, 'utf-8');
  content = content.replace(
    /'WINPTY_COMMIT_HASH%': '<!\(cmd \/c "cd shared && GetCommitHash\.bat"\)'/,
    "'WINPTY_COMMIT_HASH%': 'none'"
  );
  content = content.replace(
    /'<!\(cmd \/c "cd shared && UpdateGenVersion\.bat <\(WINPTY_COMMIT_HASH\)"\)'/,
    "'gen'"
  );
  content = content.replace(/'SpectreMitigation': 'Spectre'/g, '');
  content = content.replace(/'msvs_configuration_attributes': \{\s*\},?\n?/g, '');
  content = content.replace(/\s*'\/guard:cf',?\n?/g, '\n');
  content = content.replace(/\s*'\/ZH:SHA_256',?\n?/g, '\n');
  fs.writeFileSync(winptyGyp, content);
}

// 3. Patch binding.gyp - remove Spectre mitigation
const bindingGyp = path.join(nodeModules, 'binding.gyp');
if (fs.existsSync(bindingGyp)) {
  let content = fs.readFileSync(bindingGyp, 'utf-8');
  content = content.replace(/'SpectreMitigation': 'Spectre'/g, '');
  content = content.replace(/'msvs_configuration_attributes': \{\s*\},?\n?/g, '');
  content = content.replace(/\s*'\/guard:cf',?\n?/g, '\n');
  content = content.replace(/\s*'\/ZH:SHA_256',?\n?/g, '\n');
  fs.writeFileSync(bindingGyp, content);
}

console.log('node-pty patched successfully for Windows build.');
